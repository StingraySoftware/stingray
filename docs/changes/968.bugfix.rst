Speedup and improve robustness of fill_bad_time_intervals
